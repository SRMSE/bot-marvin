<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/server.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/server.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var parent_dir = process.getAbsolutePath(__dirname);
var qs = require('querystring');
var node_static = require('node-static');
var enableGracefulShutdown = require('server-graceful-shutdown');
var url = require('url');
var Stats = require(parent_dir + '/lib/stats.js');

/**
  Represents web app and REST API server.
  @author Tilak Patidar &lt;tilakpatidar@gmail.com>
  @constructor
  @param {Message} message_obj

*/
var Server = function(message_obj) {
    var message = message_obj;
    var log = message.get('log');
    var config = message.get('config');
    var pool = message.get('pool');
    var cluster = message.get('cluster');

    /**
      Converts api queries into MongoDB queries
      @type {Stats}
      @private
      @param {Message} message
    */
    var stats = new Stats(message);

    /**
      Node-static file server for hosting static files in /server dir.
      @private
    */
    var fileServer = new node_static.Server(parent_dir + '/server');


    /**
      Http server for API requests.
      @private
    */
    var server = require('http').createServer(function(request, response) {
        var urlparts = url.parse(request.url.toString(), true);
        if (urlparts.path.indexOf("/ask") >= 0) {
            if (request.method === "POST") {
                var body = "";
                request.on('data', function(chunk) {
                    body += chunk;
                });
                request.on('end', function() {
                    var j = qs.parse(body);
                    var js = JSON.parse(j["data"]);
                    var bot_name = j["bot_name"];

                    if (urlparts.query["q"] === "put-config") {
                        stats.setConfig(bot_name, js, function(err, results) {
                            response.write(JSON.stringify(results));
                            response.end();
                        });
                    } else if (urlparts.query["q"] === "put-seed") {
                        stats.setSeed(js, function(err, results) {
                            response.write(JSON.stringify(results));
                            response.end();
                        });
                    }

                });
            }

            switch (urlparts.query["q"]) {
                case "main-stats":
                    stats.crawlStats(function(dic) {
                        response.write(JSON.stringify(dic));
                        response.end();
                    });
                    break;
                case "active-bots":
                    stats.activeBots(function(dic) {
                        response.write(JSON.stringify(dic));
                        response.end();
                    });
                    break;
                case "read-log":
                    var type = urlparts["query"]["type"];
                    var n = urlparts['query']['n'];
                    var bot_name = urlparts['query']['bot_name'];
                    stats.readLog(bot_name, type, parseInt(n), function(st, data) {
                        response.write(data);
                        response.end();
                    });
                    break;
                case "readTerminal":
                    var bot_name = urlparts['query']['bot_name'];
                    stats.readTerminal(bot_name, function(st, data) {
                        response.write(data);
                        response.end();
                    });
                    break;
                case "cluster-info":
                    stats.clusterInfo(function(err, results) {
                        response.write(JSON.stringify(results));
                        response.end();
                    });
                    break;
                case "get-config":
                    var bot_name = urlparts['query']['bot_name'];
                    stats.getConfig(bot_name, function(err, results) {
                        response.write(JSON.stringify(results));
                        response.end();
                    });
                    break;
                case "get-seed":
                    stats.getSeed(function(err, results) {
                        response.write(JSON.stringify(results));
                        response.end();
                    });
                    break;
                case "get-failed-pages":
                    stats.getFailedPages(urlparts['query']['bot_name'], parseInt(urlparts['query']['i']), parseInt(urlparts['query']['n']), urlparts['query']['sort'], parseInt(urlparts['query']['sort_type']), function(err, results, count) {
                        res = {
                            results: results,
                            page_count: count
                        };
                        response.write(JSON.stringify(res));
                        response.end();
                    });
                    break;
                case "get-crawled-pages":
                    stats.getCrawledPages(urlparts['query']['bot_name'], parseInt(urlparts['query']['i']), parseInt(urlparts['query']['n']), urlparts['query']['sort'], parseInt(urlparts['query']['sort_type']), function(err, results, count) {
                        res = {
                            results: results,
                            page_count: count
                        };
                        //console.log(count)
                        response.write(JSON.stringify(res));
                        response.end();
                    });
                    break;
                case "get-total-buckets":
                    stats.getTotalBuckets(urlparts['query']['bot_name'], parseInt(urlparts['query']['i']), parseInt(urlparts['query']['n']), urlparts['query']['sort'], parseInt(urlparts['query']['sort_type']), function(err, results, count) {
                        res = {
                            results: results,
                            page_count: count
                        };
                        response.write(JSON.stringify(res));
                        response.end();
                    });
                    break;
                case "get-processed-buckets":
                    stats.getProcessedBuckets(urlparts['query']['bot_name'], parseInt(urlparts['query']['i']), parseInt(urlparts['query']['n']), urlparts['query']['sort'], parseInt(urlparts['query']['sort_type']), function(err, results, count) {
                        res = {
                            results: results,
                            page_count: count
                        };
                        response.write(JSON.stringify(res));
                        response.end();
                    });
                    break;
                case "get-page":
                    stats.getPage(urlparts['query']['url'], function(err, results) {
                        response.write(JSON.stringify(results));
                        response.end();
                    });
                    break;
                case "get-bucket":
                    stats.getBucket(urlparts['query']['url'], function(err, results) {
                        response.write(JSON.stringify(results));
                        response.end();
                    });
                    break;
                case "search":
                    //console.log(stats);
                    stats.search(urlparts['query']['text'], urlparts["query"]["i"], function(err, results) {
                        response.write(JSON.stringify(results));
                        response.end();
                    });
                    break;
            };




        } else {
            //important method do not remove
            request.addListener('end', function() {
                fileServer.serve(request, response);
            }).resume();
        }
    });


    /**
      Starts the API and file server.
      @public
    */
    this.start = function() {


        try {
            server.listen(2020);
        } catch (err) {
            console.log(err);
        }

        cluster.file_server = server;
        cluster.fileServer = fileServer.serve;

        server.on('connection', function server_connection(socket) {
            socket.setTimeout(2000);
        });

        server.on("listening", function server_listening() {
            try {
                enableGracefulShutdown(cluster.file_server);
                enableGracefulShutdown(cluster.fileServer);
            } catch (err) {
                //console.log(err);
            }
            msg("Server is listening", "success");
        });


        server.on("error", function server_error(e) {
            if (e.code === "EADDRINUSE") {
                msg("Web app occupied maybe an instance is already running ", "error");
            }

        });
    };

    function msg() {
        log.put(arguments[0], arguments[1], __filename.split('/').pop(), arguments.callee.caller.name.toString());
    }

}

module.exports = Server;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ArgumentProcesser.html">ArgumentProcesser</a></li><li><a href="Bot.html">Bot</a></li><li><a href="Bucket.html">Bucket</a></li><li><a href="BucketProxy.html">BucketProxy</a></li><li><a href="ChildManager.html">ChildManager</a></li><li><a href="Cluster.html">Cluster</a></li><li><a href="Config.html">Config</a></li><li><a href="Crawler.html">Crawler</a></li><li><a href="DBConfig.html">DBConfig</a></li><li><a href="DepCheck.html">DepCheck</a></li><li><a href="Graph.html">Graph</a></li><li><a href="JSONX.html">JSONX</a></li><li><a href="Lock.html">Lock</a></li><li><a href="Logger.html">Logger</a></li><li><a href="Message.html">Message</a></li><li><a href="MongoDB.html">MongoDB</a></li><li><a href="ObjectX.html">ObjectX</a></li><li><a href="Pool.html">Pool</a></li><li><a href="Proto.html">Proto</a></li><li><a href="Robots.html">Robots</a></li><li><a href="RSSFetcher.html">RSSFetcher</a></li><li><a href="Score.html">Score</a></li><li><a href="SeedLoader.html">SeedLoader</a></li><li><a href="Server.html">Server</a></li><li><a href="Sitemap.html">Sitemap</a></li><li><a href="Spawn.html">Spawn</a></li><li><a href="Stats.html">Stats</a></li><li><a href="Tika.html">Tika</a></li><li><a href="TikaQueue.html">TikaQueue</a></li><li><a href="URLCreator.html">URLCreator</a></li><li><a href="URLCreator_url-URL.html">URL</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sat Jul 23 2016 18:31:34 GMT+0530 (IST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
